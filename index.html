<script>
  const slider = document.getElementById('slider');
  const slides = Array.from(slider.children);
  const dotsContainer = document.getElementById('dots');
  const prevBtn = document.querySelector('.prev');
  const nextBtn = document.querySelector('.next');
  let currentIndex = 0;
  let autoPlayTimer;
  let userInteracted = false;

  // ドット生成
  slides.forEach((_, idx) => {
    const dot = document.createElement('span');
    dot.classList.add('dot');
    dot.addEventListener('click', () => {
      stopAutoPlay();
      goToSlide(idx);
    });
    dotsContainer.appendChild(dot);
  });
  const dots = Array.from(dotsContainer.children);

  // アクティブ更新
  function updateActive() {
    let closestIdx = 0;
    let closestDist = Infinity;
    const center = window.innerWidth / 2;

    slides.forEach((slide, idx) => {
      const rect = slide.getBoundingClientRect();
      const slideCenter = rect.left + rect.width / 2;
      const dist = Math.abs(center - slideCenter);
      if (dist < closestDist) {
        closestDist = dist;
        closestIdx = idx;
      }
    });

    currentIndex = closestIdx;
    slides.forEach(s => s.classList.remove('active'));
    dots.forEach(d => d.classList.remove('active'));
    slides[currentIndex].classList.add('active');
    dots[currentIndex].classList.add('active');
  }

  function goToSlide(idx) {
    slides[idx].scrollIntoView({ behavior: "smooth", inline: "center" });
    currentIndex = idx;
    updateActive();
  }

  function nextSlide() {
    let next = (currentIndex + 1) % slides.length;
    goToSlide(next);
  }
  function prevSlide() {
    let prev = (currentIndex - 1 + slides.length) % slides.length;
    goToSlide(prev);
  }

  prevBtn.addEventListener('click', () => { stopAutoPlay(); prevSlide(); });
  nextBtn.addEventListener('click', () => { stopAutoPlay(); nextSlide(); });

  slider.addEventListener('scroll', () => {
    window.requestAnimationFrame(updateActive);
    stopAutoPlay();
  });

  // 自動再生管理
  function startAutoPlay() {
    stopAutoPlay();
    autoPlayTimer = setInterval(nextSlide, 3000);
  }
  function stopAutoPlay() {
    clearInterval(autoPlayTimer);
    clearTimeout(userInteracted);
    userInteracted = setTimeout(startAutoPlay, 5000);
  }

  // 初期表示を真ん中から
  const middleIndex = Math.floor(slides.length / 2);
  goToSlide(middleIndex);
  startAutoPlay();
</script>
